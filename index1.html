<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallingApp - Username Edition</title>
    <style>
        /* Part 2: CSS Styling */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        :root {
            --wa-header-bg: #005c97;
            --wa-accent-blue: #34B7F1;
            --wa-message-out-bg: #e1f6fb;
            --wa-message-in-bg: #ffffff;
            --wa-app-bg: #f0f2f5;
            --wa-chat-bg: #e5ddd5;
            --wa-icon-color: #f0f2f5;
            --wa-text-primary: #111b21;
            --wa-text-secondary: #667781;
            --wa-border-color: #e9edef;
            --wa-active-tab-indicator: var(--wa-accent-blue);
            --wa-button-color: #008069;
            --wa-link-color: #00a8e8;
            --wa-shadow: rgba(17, 27, 33, 0.15);
            --danger-color: #e91e63;
            --success-color: #4CAF50;
        }

        * { box-sizing: border-box; outline: none; }

        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #d1d7db;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); }

        /* Generic Icon Button */
        .icon-btn {
            background: none; border: none; cursor: pointer; padding: 8px;
            color: var(--wa-icon-color); display: flex; align-items: center; justify-content: center;
        }
        .icon-btn svg { width: 24px; height: 24px; fill: currentColor; }

        /* App Container */
        #app-container {
            width: 100%; max-width: 450px; height: 100%; max-height: 950px;
            background: #fff; position: relative; overflow: hidden;
            box-shadow: 0 4px 12px var(--wa-shadow);
        }
        @media (min-width: 480px) { #app-container { border-radius: 8px; height: 95vh; } }

        /* Views Layout */
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; background: var(--wa-app-bg); z-index: 10;
        }
        .view.active { display: flex; }

        /* --- Auth View --- */
        #auth-view {
            justify-content: center; align-items: center; padding: 20px;
            background: var(--wa-app-bg); text-align: center;
        }
        #auth-view h1 { color: var(--wa-header-bg); margin-bottom: 30px; }
        .auth-form { width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 15px; }
        .auth-input {
            padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;
        }
        .auth-input:focus { border-color: var(--wa-accent-blue); }
        .primary-btn {
            padding: 12px; background: var(--wa-button-color); color: white;
            border: none; border-radius: 4px; font-weight: 500; cursor: pointer; font-size: 16px;
        }
        .link-text { color: var(--wa-link-color); cursor: pointer; margin-top: 10px; font-size: 14px; }
        .error-msg { color: var(--danger-color); font-size: 13px; min-height: 18px; }

        /* --- Main View --- */
        .main-header {
            background: var(--wa-header-bg); color: white; flex-shrink: 0;
        }
        .header-top {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;
        }
        .header-title { font-size: 20px; font-weight: 500; }
        .header-actions { display: flex; gap: 5px; }
        
        .header-nav { display: flex; }
        .nav-tab {
            flex: 1; text-align: center; padding: 15px 0; color: rgba(255,255,255,0.6);
            cursor: pointer; position: relative; font-weight: 500; text-transform: uppercase; font-size: 14px;
        }
        .nav-tab.active { color: white; border-bottom: 3px solid white; }
        .badge {
            background: var(--wa-accent-blue); color: #fff; font-size: 10px;
            padding: 2px 5px; border-radius: 10px; margin-left: 5px; vertical-align: middle;
            display: none;
        }

        #main-content { flex: 1; overflow-y: auto; position: relative; }
        .content-panel { display: none; height: 100%; }
        .content-panel.active { display: block; }

        /* List Items (Chats, Updates) */
        .list-item {
            display: flex; align-items: center; padding: 12px 15px; background: #fff;
            border-bottom: 1px solid var(--wa-border-color); cursor: pointer;
        }
        .list-item:hover { background: #f5f5f5; }
        .item-avatar {
            width: 45px; height: 45px; background: #ddd; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px;
        }
        .item-info { flex: 1; overflow: hidden; }
        .item-title { font-weight: 500; color: var(--wa-text-primary); margin-bottom: 3px; }
        .item-subtext { font-size: 13px; color: var(--wa-text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-meta { font-size: 11px; color: var(--wa-text-secondary); text-align: right; min-width: 50px;}

        /* --- Chat View --- */
        #chat-view { z-index: 20; background: var(--wa-chat-bg); }
        .chat-header {
            background: var(--wa-header-bg); color: white; padding: 8px 10px;
            display: flex; align-items: center; gap: 10px; flex-shrink: 0;
        }
        .chat-avatar { width: 35px; height: 35px; border-radius: 50%; background: #ccc; display: flex; align-items: center; justify-content: center; }
        .chat-info { flex: 1; }
        .chat-name { font-weight: 500; font-size: 16px; }
        
        #chat-messages {
            flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23bdbdbd' fill-opacity='0.15' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
        }
        
        .message-bubble {
            max-width: 75%; padding: 8px 10px; border-radius: 7.5px; position: relative; font-size: 14.2px;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); word-wrap: break-word;
        }
        .message-received { align-self: flex-start; background: var(--wa-message-in-bg); border-top-left-radius: 0; }
        .message-sent { align-self: flex-end; background: var(--wa-message-out-bg); border-top-right-radius: 0; }
        .msg-time { font-size: 10px; color: #999; text-align: right; margin-top: 4px; display: block; }

        #chat-input-container {
            background: #f0f2f5; padding: 8px; display: flex; align-items: center; gap: 8px;
        }
        #chat-input {
            flex: 1; padding: 10px 15px; border-radius: 20px; border: none; background: #fff;
        }
        #chat-send-btn {
            background: var(--wa-button-color); color: white; border-radius: 50%; width: 40px; height: 40px; padding: 0;
        }

        /* --- Call View --- */
        .call-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 50; display: none; overflow: hidden;
        }
        .call-view.active { display: block; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video {
            position: absolute; bottom: 120px; right: 20px; width: 100px; height: 140px;
            background: #333; border-radius: 8px; object-fit: cover; border: 2px solid #fff; cursor: grab;
        }
        .call-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.6) 100%);
            display: flex; flex-direction: column; justify-content: space-between; padding: 40px 20px; pointer-events: none;
        }
        .caller-info { text-align: center; color: white; }
        .caller-name { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
        .call-status { font-size: 14px; opacity: 0.8; }
        .call-controls { display: flex; justify-content: center; gap: 30px; pointer-events: auto; }
        .control-btn {
            width: 55px; height: 55px; border-radius: 50%; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; color: white;
        }
        .btn-end { background: var(--danger-color); }
        .btn-accept { background: var(--success-color); }
        .btn-mute { background: rgba(255,255,255,0.2); }

        /* --- Modals --- */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100; display: none;
            justify-content: center; align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #fff; width: 90%; max-width: 320px; padding: 20px;
            border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .modal-title { font-size: 18px; margin-bottom: 15px; font-weight: bold; color: var(--wa-text-primary); }
        .modal-body input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; }
        .btn-secondary { background: transparent; color: var(--wa-button-color); padding: 8px 12px; border: none; cursor: pointer; font-weight: 500;}

        /* Icons SVG Paths */
        .svg-icon { display: block; }
    </style>
</head>
<body>

<div id="app-container">
    <audio id="ringtone" loop>
        <source src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU" type="audio/wav">
    </audio>

    <div id="auth-view" class="view active">
        <h1>CallingApp</h1>
        
        <div id="login-form" class="auth-form">
            <div id="login-error" class="error-msg"></div>
            <input type="email" id="login-email" class="auth-input" placeholder="Email Address">
            <input type="password" id="login-password" class="auth-input" placeholder="Password">
            <button id="login-btn" class="primary-btn">Log In</button>
            <div class="link-text" onclick="toggleAuth('signup')">Create a new account</div>
        </div>

        <div id="signup-form" class="auth-form" style="display:none;">
            <div id="signup-error" class="error-msg"></div>
            <input type="email" id="signup-email" class="auth-input" placeholder="Email Address">
            <input type="password" id="signup-password" class="auth-input" placeholder="Password">
            <button id="signup-btn" class="primary-btn">Sign Up</button>
            <div class="link-text" onclick="toggleAuth('login')">Already have an account?</div>
        </div>
    </div>

    <div id="main-view" class="view">
        <header class="main-header">
            <div class="header-top">
                <div class="header-title">CallingApp</div>
                <div class="header-actions">
                    <button id="add-friend-btn" class="icon-btn" onclick="showModal('add-friend-modal')">
                         <svg viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </button>
                    <button id="menu-btn" class="icon-btn" onclick="showModal('profile-view-modal')">
                         <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    </button>
                </div>
            </div>
            <div class="header-nav">
                <div id="nav-home" class="nav-tab active" onclick="switchTab('home')">Chats <span id="chat-badge" class="badge">0</span></div>
                <div id="nav-notifications" class="nav-tab" onclick="switchTab('notifications')">Updates <span id="update-badge" class="badge">0</span></div>
                <div id="nav-calls" class="nav-tab" onclick="switchTab('calls')">Calls</div>
            </div>
        </header>

        <main id="main-content">
            <div id="home-content" class="content-panel active">
                </div>
            <div id="notifications-content" class="content-panel">
                </div>
            <div id="calls-content" class="content-panel">
                </div>
        </main>
    </div>

    <div id="chat-view" class="view">
        <header class="chat-header">
            <button class="icon-btn" onclick="showView('main-view')">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <div class="chat-avatar" id="chat-header-avatar">?</div>
            <div class="chat-info">
                <div class="chat-name" id="chat-header-name">User</div>
            </div>
            <button id="video-call-btn" class="icon-btn" onclick="startCall('video')">
                <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
            </button>
            <button id="voice-call-btn" class="icon-btn" onclick="startCall('audio')">
                <svg viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.43-5.15-3.75-6.59-6.59l1.97-1.57c.26-.26.36-.62.25-1-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3.3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/></svg>
            </button>
            <button id="chat-more-btn" class="icon-btn" onclick="blockUserAction()">
                 <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
            </button>
        </header>

        <div id="chat-messages">
            </div>

        <div id="chat-input-container">
            <input type="text" id="chat-input" placeholder="Type a message">
            <button id="chat-send-btn" class="icon-btn" onclick="sendMessage()">
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>

    <div id="video-call-view" class="call-view">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="call-overlay">
            <div class="caller-info">
                <div class="caller-name" id="call-partner-name">...</div>
                <div class="call-status" id="call-status-text">Calling...</div>
            </div>
            <div class="call-controls">
                <button class="control-btn btn-end" onclick="endCall()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="profile-setup-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Setup Profile</div>
            <div class="modal-body">
                <p style="font-size:12px; color:#666; margin-bottom:10px;">Choose a unique username and an emoji avatar.</p>
                <div id="setup-error" class="error-msg"></div>
                <input type="text" id="setup-username" placeholder="Username (e.g. user123)" oninput="this.value = this.value.toLowerCase().replace(/[^a-z0-9]/g, '')">
                <input type="text" id="setup-emoji" placeholder="Emoji (e.g. ðŸ˜Ž)" maxlength="2">
            </div>
            <div class="modal-footer">
                <button class="primary-btn" onclick="saveProfile()">Save & Continue</button>
            </div>
        </div>
    </div>

    <div id="add-friend-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Add New Friend</div>
            <div class="modal-body">
                <p style="font-size:13px; color:#555;">Enter the username of your friend.</p>
                <div id="add-friend-msg" class="error-msg" style="color:var(--wa-button-color)"></div>
                <input type="text" id="friend-username" placeholder="Enter Username">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('add-friend-modal')">Cancel</button>
                <button class="primary-btn" onclick="sendFriendRequest()">Send Request</button>
            </div>
        </div>
    </div>

    <div id="profile-view-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">My Profile</div>
            <div class="modal-body" style="text-align:center;">
                <div id="my-emoji" style="font-size:40px; margin-bottom:10px;"></div>
                <h3 id="my-username" style="margin:0; color:var(--wa-text-primary)"></h3>
                <p style="font-size:12px; color:#888;">Unique ID: <span id="my-uid"></span></p>
                <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                <button class="btn-secondary" onclick="unblockUserPrompt()">Manage Blocked Users</button>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn-end control-btn" style="width:auto; padding:0 20px; font-size:14px; border-radius:4px;" onclick="logout()">Logout</button>
                <button class="btn-secondary" onclick="closeModal('profile-view-modal')">Close</button>
            </div>
        </div>
    </div>

    <div id="incoming-call-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-title">Incoming Call</div>
            <div class="modal-body">
                <div id="incoming-caller-name" style="font-size: 20px; font-weight: bold; margin-bottom: 20px;">User</div>
                <div style="display:flex; justify-content:center; gap: 20px;">
                    <button class="control-btn btn-end" onclick="rejectCall()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
                    </button>
                    <button class="control-btn btn-accept" onclick="acceptCall()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.8
